name: Deploy Gateway (Workers)

on:
  push:
    branches: [ main ]
    paths:
      - "workers/**"
      - ".github/workflows/cf-deploy.yml"
  workflow_dispatch:

    
jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    # Do NOT shadow these names in steps; keep secrets here and echo them only where needed.
    env:
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    defaults:
      run:
        working-directory: workers  # <- folder with wrangler.toml

    steps:
      - uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm i -g wrangler@4

      # -------- SECRETS (sensitive) --------
      - name: GH_TOKEN_DATA (staging)
        run: |
          echo -n "${{ secrets.STAGING_GH_TOKEN_DATA }}" | \
          wrangler secret put GH_TOKEN_DATA --env=staging

      - name: APP_API_KEY (staging)
        run: |
          echo -n "${{ secrets.STAGING_APP_API_KEY }}" | \
          wrangler secret put APP_API_KEY --env=staging

      - name: JWT_SECRET (staging)
        run: |
          echo -n "${{ secrets.STAGING_JWT_SECRET }}" | \
          wrangler secret put JWT_SECRET --env=staging

      # -------- VARS (non-sensitive) --------
      - name: staging
        run: |
          # IMPORTANT: DATA_BASE is a BRANCH, not a URL
          wrangler vars put MODE                --env=staging --value "mock-no-auth"
          wrangler vars put DATA_OWNER          --env=staging --value "open-gov-group"
          wrangler vars put DATA_REPO           --env=staging --value "opengov-privacy-data"
          wrangler vars put DATA_BASE           --env=staging --value "main"

          wrangler vars put DEFAULT_PROFILE_HREF --env=staging --value "https://raw.githubusercontent.com/open-gov-group/opengov-privacy-oscal/main/build/profile_resolved_catalog.json"
          wrangler vars put TEMPLATE_SSP_HREF    --env=staging --value "https://raw.githubusercontent.com/open-gov-group/opengov-privacy-oscal/main/oscal/ssp/ssp_template_ropa.json"

          wrangler vars put JWT_ISS --env=staging --value "open-privacy-api"
          wrangler vars put JWT_AUD --env=staging --value "opengov-privacy-ui"
          wrangler vars put JWT_ALG --env=staging --value "HS256"

      - name: Deploy (staging)
        run: wrangler deploy --env=staging

      - name: Healthcheck
        run: curl -fsSL https://opengov-privacy-api-staging.opengov-group.workers.dev/api/healthz